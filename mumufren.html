<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mumu Frens - Mint & Collection</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .title {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
      }

      .subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      .nav-tabs {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      .nav-tab {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .nav-tab:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .nav-tab.active {
        background: white;
        color: #667eea;
        transform: translateY(-2px);
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      /* Mint Section Styles */
      .mint-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        margin: 0 auto;
      }

      .price-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      .price {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .quantity-section {
        margin-bottom: 30px;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 15px 0;
      }

      .qty-btn {
        background: #667eea;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
      }

      .qty-btn:hover {
        background: #5a6fd8;
      }

      .qty-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .quantity-input {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        width: 80px;
        height: 40px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
      }

      .total-cost {
        margin-top: 15px;
        font-size: 1.2rem;
        color: #333;
      }

      .connect-btn,
      .mint-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin: 10px 0;
        transition: transform 0.2s ease;
      }

      .connect-btn:hover,
      .mint-btn:hover {
        transform: translateY(-2px);
      }

      .mint-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .wallet-info {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 14px;
      }

      .connect-prompt {
        background: #fff3cd;
        color: #856404;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
        border: 1px solid #ffeaa7;
      }

      /* Collection Section Styles */
      .collection-container {
        width: 100%;
      }

      .collection-stats {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 30px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .stat-item h3 {
        color: #667eea;
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .stat-item p {
        color: #666;
        font-size: 0.9rem;
      }

      .collection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }

      .nft-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        text-align: center;
      }

      .nft-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      .nft-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 3rem;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
      }

      .nft-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
      }

      .nft-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
      }

      .nft-id {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .nft-message {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        font-style: italic;
        color: #555;
        margin: 10px 0;
        font-size: 0.9rem;
      }

      .nft-links {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .nft-link {
        color: #667eea;
        text-decoration: none;
        font-size: 0.8rem;
        padding: 5px 8px;
        background: #f8f9fa;
        border-radius: 6px;
        transition: background 0.2s ease;
      }

      .nft-link:hover {
        background: #e9ecef;
      }

      .empty-state,
      .loading {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .empty-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }

      .empty-text {
        color: #666;
        margin-bottom: 25px;
      }

      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status {
        margin: 15px 0;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        text-align: center;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .contract-link {
        margin-top: 20px;
        font-size: 12px;
        color: #666;
      }

      .contract-link a {
        color: #667eea;
        text-decoration: none;
      }

      @media (max-width: 768px) {
        .title {
          font-size: 2rem;
        }

        .nav-tabs {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .mint-container {
          padding: 30px 20px;
        }

        .collection-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 20px;
        }

        .nft-links {
          gap: 5px;
        }

        .nft-link {
          font-size: 0.75rem;
          padding: 4px 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">üêÆ Mumu Frens</h1>
        <p class="subtitle">Mint and manage your adorable NFT collection</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('mint')">
          Mint
        </button>
        <button class="nav-tab" onclick="showSection('collection')">
          My Collection
        </button>
      </div>

      <!-- Mint Section -->
      <div id="mint" class="section active">
        <div class="mint-container">
          <div class="price-info">
            <div class="price">0.005 ETH</div>
            <div>per NFT</div>
          </div>

          <div class="quantity-section">
            <label>Quantity</label>
            <div class="quantity-controls">
              <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
              <input
                type="number"
                class="quantity-input"
                id="quantity"
                value="1"
                min="1"
                max="10"
                readonly
              />
              <button class="qty-btn" onclick="changeQuantity(1)">+</button>
            </div>
            <div class="total-cost">
              Total: <strong><span id="totalCost">0.005 ETH</span></strong>
            </div>
          </div>

          <div id="walletPrompt" class="connect-prompt">
            <strong
              >Please connect your wallet using the wallet button in the top
              navigation to mint NFTs.</strong
            >
          </div>

          <div id="walletInfo" class="wallet-info" style="display: none">
            <div>Connected: <span id="walletAddress"></span></div>
          </div>

          <button
            id="mintBtn"
            class="mint-btn"
            onclick="mint()"
            style="display: none"
          >
            Mint Mumu Fren
          </button>

          <div id="mintStatus"></div>

          <div class="contract-link">
            <a
              href="https://etherscan.io/address/0xC388e31d7a85F59a18E4D3bCE52f531F5ebA1567"
              target="_blank"
            >
              View Contract on Etherscan
            </a>
          </div>
        </div>
      </div>

      <!-- Collection Section -->
      <div id="collection" class="section">
        <div class="collection-container">
          <div
            id="collectionStats"
            class="collection-stats"
            style="display: none"
          >
            <div class="stats-grid">
              <div class="stat-item">
                <h3 id="totalNfts">-</h3>
                <p>Total NFTs Owned</p>
              </div>
              <div class="stat-item">
                <h3 id="walletAddressShort">-</h3>
                <p>Your Wallet</p>
              </div>
              <div class="stat-item">
                <h3>Ethereum</h3>
                <p>Network</p>
              </div>
            </div>
          </div>

          <div id="collectionStatus"></div>

          <div id="collectionContainer">
            <div class="empty-state">
              <div class="empty-icon">üêÆ</div>
              <div class="empty-title">Connect Your Wallet</div>
              <div class="empty-text">
                Connect your wallet using the wallet button in the top
                navigation to view your Mumu Frens collection
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const CONTRACT_ADDRESS = "0xC388e31d7a85F59a18E4D3bCE52f531F5ebA1567";
      const CONTRACT_ABI = [
        {
          inputs: [
            {
              components: [
                { internalType: "bytes32", name: "key", type: "bytes32" },
                { internalType: "bytes32[]", name: "proof", type: "bytes32[]" },
              ],
              internalType: "struct Auth",
              name: "auth",
              type: "tuple",
            },
            { internalType: "uint256", name: "quantity", type: "uint256" },
            { internalType: "address", name: "affiliate", type: "address" },
            { internalType: "bytes", name: "signature", type: "bytes" },
          ],
          name: "mint",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "owner", type: "address" }],
          name: "balanceOf",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "tokenId", type: "uint256" },
          ],
          name: "ownerOf",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "tokenId", type: "uint256" },
          ],
          name: "tokenURI",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "tokenId", type: "uint256" },
          ],
          name: "getTokenMsg",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "view",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "from",
              type: "address",
            },
            {
              indexed: true,
              internalType: "address",
              name: "to",
              type: "address",
            },
            {
              indexed: true,
              internalType: "uint256",
              name: "tokenId",
              type: "uint256",
            },
          ],
          name: "Transfer",
          type: "event",
        },
      ];

      let provider;
      let signer;
      let contract;
      let userAccount;
      let currentSection = "mint";

      // Get connected wallet from localStorage (set by walletConnect.js)
      function getConnectedWallet() {
        return localStorage.getItem("connectedWallet");
      }

      // Check if wallet is connected and setup provider/signer
      async function initializeWalletConnection() {
        const connectedWallet = getConnectedWallet();

        if (connectedWallet && window.ethereum) {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum);

            // Verify the account is still connected
            const accounts = await window.ethereum.request({
              method: "eth_accounts",
            });
            if (accounts.includes(connectedWallet)) {
              userAccount = connectedWallet;
              signer = provider.getSigner();
              contract = new ethers.Contract(
                CONTRACT_ADDRESS,
                CONTRACT_ABI,
                signer
              );
              updateWalletUI();

              // Load collection if on collection tab
              if (currentSection === "collection") {
                loadCollection();
              }
            } else {
              // Account disconnected, clear local storage
              localStorage.removeItem("connectedWallet");
              updateWalletUI();
            }
          } catch (error) {
            console.error("Error initializing wallet connection:", error);
            updateWalletUI();
          }
        } else {
          updateWalletUI();
        }
      }

      // Show section
      function showSection(sectionName) {
        // Update navigation
        document
          .querySelectorAll(".nav-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".section")
          .forEach((section) => section.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(sectionName).classList.add("active");
        currentSection = sectionName;

        // Load collection if switching to it and wallet is connected
        if (sectionName === "collection" && userAccount) {
          loadCollection();
        }
      }

      // Change quantity
      function changeQuantity(delta) {
        const input = document.getElementById("quantity");
        const current = parseInt(input.value);
        const newValue = Math.max(1, Math.min(10, current + delta));
        input.value = newValue;
        updateTotalCost();
      }

      // Update total cost display
      function updateTotalCost() {
        const quantity = parseInt(document.getElementById("quantity").value);
        const total = (quantity * 0.005).toFixed(3);
        document.getElementById("totalCost").textContent = `${total} ETH`;
      }

      // Show status message
      function showStatus(message, type, target = "mintStatus") {
        const statusDiv = document.getElementById(target);
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;

        if (type === "success" || type === "error") {
          setTimeout(() => {
            statusDiv.textContent = "";
            statusDiv.className = "";
          }, 8000);
        }
      }

      // Update wallet UI based on connection status
      function updateWalletUI() {
        const connectedWallet = getConnectedWallet();

        if (connectedWallet && userAccount) {
          const shortAddress = `${userAccount.slice(
            0,
            6
          )}...${userAccount.slice(-4)}`;

          // Update mint section
          document.getElementById("walletPrompt").style.display = "none";
          document.getElementById("walletInfo").style.display = "block";
          document.getElementById("mintBtn").style.display = "block";
          document.getElementById("walletAddress").textContent = shortAddress;

          // Update collection section
          document.getElementById("walletAddressShort").textContent =
            shortAddress;
        } else {
          // Reset UI to disconnected state
          document.getElementById("walletPrompt").style.display = "block";
          document.getElementById("walletInfo").style.display = "none";
          document.getElementById("mintBtn").style.display = "none";
          document.getElementById("collectionStats").style.display = "none";

          // Reset collection view
          document.getElementById("collectionContainer").innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üêÆ</div>
              <div class="empty-title">Connect Your Wallet</div>
              <div class="empty-text">
                Connect your wallet using the wallet button in the top navigation to view your Mumu Frens collection
              </div>
            </div>
          `;

          userAccount = null;
          contract = null;
        }
      }

      // Mint NFT
      async function mint() {
        if (!contract) {
          showStatus("Please connect your wallet first", "error");
          return;
        }

        const quantity = parseInt(document.getElementById("quantity").value);
        const mintBtn = document.getElementById("mintBtn");

        try {
          mintBtn.disabled = true;
          mintBtn.innerHTML = '<span class="spinner"></span> Minting...';

          const auth = {
            key: "0x0000000000000000000000000000000000000000000000000000000000000000",
            proof: [],
          };
          const affiliate = ethers.constants.AddressZero;
          const signature = "0x";

          const pricePerMint = ethers.utils.parseEther("0.005");
          const totalCost = pricePerMint.mul(quantity);

          showStatus(
            `Sending transaction for ${quantity} NFT${
              quantity > 1 ? "s" : ""
            }...`,
            "info"
          );

          const tx = await contract.mint(auth, quantity, affiliate, signature, {
            value: totalCost,
          });

          showStatus(`Transaction sent! Hash: ${tx.hash}`, "info");
          await tx.wait();

          showStatus(
            `Successfully minted ${quantity} Mumu Fren${
              quantity > 1 ? "s" : ""
            }! üéâ`,
            "success"
          );

          // Refresh collection if user is viewing it
          if (currentSection === "collection") {
            setTimeout(() => loadCollection(), 2000);
          }
        } catch (error) {
          console.error("Mint error:", error);

          if (error.code === 4001) {
            showStatus("Transaction cancelled by user", "error");
          } else if (error.message.includes("insufficient funds")) {
            showStatus("Insufficient funds for transaction", "error");
          } else {
            showStatus(
              `Mint failed: ${
                error.reason || error.message || "Unknown error"
              }`,
              "error"
            );
          }
        } finally {
          mintBtn.disabled = false;
          mintBtn.textContent = "Mint Mumu Fren";
        }
      }

      // Load user's NFT collection
      async function loadCollection() {
        const container = document.getElementById("collectionContainer");

        if (!userAccount) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üêÆ</div>
              <div class="empty-title">Connect Your Wallet</div>
              <div class="empty-text">Connect your wallet using the wallet button in the top navigation to view your Mumu Frens collection</div>
            </div>
          `;
          document.getElementById("collectionStats").style.display = "none";
          return;
        }

        // Show loading state
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <h3>Loading your Mumu Frens...</h3>
            <p>This may take a moment</p>
          </div>
        `;

        try {
          const readProvider = new ethers.providers.CloudflareProvider();
          const readContract = new ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            readProvider
          );

          const balance = await readContract.balanceOf(userAccount);
          document.getElementById("totalNfts").textContent = balance.toString();
          document.getElementById("collectionStats").style.display = "block";

          if (balance.eq(0)) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">üêÆ</div>
                <div class="empty-title">No Mumu Frens Yet</div>
                <div class="empty-text">You don't own any Mumu Frens NFTs yet. Switch to the Mint tab to get started!</div>
              </div>
            `;
            return;
          }

          showStatus(
            "Fetching your NFTs from the blockchain...",
            "info",
            "collectionStatus"
          );

          const filter = readContract.filters.Transfer(null, userAccount);
          const events = await readContract.queryFilter(filter, 0, "latest");

          const tokenIds = [
            ...new Set(events.map((event) => event.args.tokenId.toString())),
          ];

          const ownedTokens = [];
          for (const tokenId of tokenIds) {
            try {
              const owner = await readContract.ownerOf(tokenId);
              if (owner.toLowerCase() === userAccount.toLowerCase()) {
                ownedTokens.push(tokenId);
              }
            } catch (error) {
              console.log(`Token ${tokenId} no longer exists or accessible`);
            }
          }

          if (ownedTokens.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">üêÆ</div>
                <div class="empty-title">No Current NFTs</div>
                <div class="empty-text">You may have transferred your Mumu Frens to another wallet.</div>
              </div>
            `;
            return;
          }

          document.getElementById("totalNfts").textContent = ownedTokens.length;
          await displayNFTs(ownedTokens, readContract);

          document.getElementById("collectionStatus").textContent = "";
          document.getElementById("collectionStatus").className = "";
        } catch (error) {
          console.error("Error loading collection:", error);
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ùå</div>
              <div class="empty-title">Error Loading Collection</div>
              <div class="empty-text">There was an error fetching your NFTs. This might be due to network issues.</div>
              <button class="connect-btn" onclick="loadCollection()">Try Again</button>
            </div>
          `;
          showStatus(
            "Error loading your collection. Please try again.",
            "error",
            "collectionStatus"
          );
        }
      }

      // Display NFTs in grid
      async function displayNFTs(tokenIds, contract) {
        const container = document.getElementById("collectionContainer");
        container.innerHTML =
          '<div class="collection-grid" id="nftGrid"></div>';
        const grid = document.getElementById("nftGrid");

        for (const tokenId of tokenIds) {
          const nftCard = await createNFTCard(tokenId, contract);
          grid.appendChild(nftCard);
        }
      }

      // Create individual NFT card
      async function createNFTCard(tokenId, contract) {
        const card = document.createElement("div");
        card.className = "nft-card";

        card.innerHTML = `
          <div class="nft-image">üêÆ #${tokenId}</div>
          <div class="nft-title">Mumu Fren #${tokenId}</div>
          <div class="nft-id">Token ID: ${tokenId}</div>
          <div class="nft-links">
            <a href="https://etherscan.io/nft/${CONTRACT_ADDRESS}/${tokenId}" target="_blank" class="nft-link">
              Etherscan
            </a>
            <a href="https://opensea.io/assets/ethereum/${CONTRACT_ADDRESS}/${tokenId}" target="_blank" class="nft-link">
              OpenSea
            </a>
          </div>
        `;

        try {
          const message = await contract.getTokenMsg(tokenId);
          if (message && message.trim()) {
            const messageDiv = document.createElement("div");
            messageDiv.className = "nft-message";
            messageDiv.textContent = message;
            card.insertBefore(messageDiv, card.querySelector(".nft-links"));
          }
        } catch (error) {
          // No message
        }

        try {
          const tokenURI = await contract.tokenURI(tokenId);
          if (tokenURI && tokenURI.trim() && tokenURI !== "") {
            const metadataLink = document.createElement("a");
            metadataLink.href = tokenURI;
            metadataLink.target = "_blank";
            metadataLink.className = "nft-link";
            metadataLink.textContent = "Metadata";
            card.querySelector(".nft-links").appendChild(metadataLink);

            try {
              const response = await fetch(tokenURI);
              const metadata = await response.json();
              if (metadata.image) {
                const img = document.createElement("img");
                img.src = metadata.image.replace(
                  "ipfs://",
                  "https://ipfs.io/ipfs/"
                );
                img.onerror = () => {};
                card.querySelector(".nft-image").innerHTML = "";
                card.querySelector(".nft-image").appendChild(img);
              }
            } catch (metadataError) {
              console.log(`Could not load metadata for token ${tokenId}`);
            }
          }
        } catch (error) {
          // No URI
        }

        return card;
      }

      // Listen for wallet connection changes from walletConnect.js
      function handleWalletConnectionChange() {
        // Re-initialize wallet connection when storage changes
        initializeWalletConnection();
      }

      // Listen for localStorage changes (wallet connect/disconnect)
      window.addEventListener("storage", (e) => {
        if (e.key === "connectedWallet") {
          handleWalletConnectionChange();
        }
      });

      // Handle account changes from MetaMask
      if (typeof window.ethereum !== "undefined") {
        window.ethereum.on("accountsChanged", (accounts) => {
          // Let walletConnect.js handle the account change
          // This will trigger a storage event that we'll pick up
          setTimeout(handleWalletConnectionChange, 100);
        });

        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
      }

      // Initialize on page load
      window.addEventListener("load", () => {
        updateTotalCost();
        initializeWalletConnection();
      });

      // Also check for wallet connection changes every few seconds
      // This helps catch cases where walletConnect.js updates the connection
      setInterval(handleWalletConnectionChange, 3000);
    </script>
  </body>
</html>
