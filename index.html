<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta
      name="description"
      content="Learn web3 programming skills along with i2."
    />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta
      name="keywords"
      content="web3,programming,coding,html5,css,sol,solidity,nft,crypto,js,javascript"
    />

    <title>SURF WORKS</title>

    <link rel="stylesheet" href="style.css" />

    <link rel="icon" href="images/i2 icon.png" />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <script
      src="https://kit.fontawesome.com/d221468419.js"
      crossorigin="anonymous"
    ></script>

    <script src="sublogic/navScript.js"></script>
    <script src="sublogic/imageScroll.js"></script>
    <script src="sublogic/aniCanvas.js"></script>
    <script src="sublogic/walletConnect.js"></script>
    <script type="module" src="sublogic/mintMumuFren.js"></script>
    <script type="module" src="sublogic/whirlpool.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>
    <noscript>javascript is not enabled!</noscript>

    <div class="header">
      <div class="nav-vector-container">
        <img
          class="nav-vector-innard"
          id="nav-vector-innard"
          src="images/i2 DAO logo.png"
        />
        <img
          class="nav-vector-cog"
          id="nav-vector-cog"
          src="images/nav_cog.svg"
        />
      </div>

      <div class="nav-vector-container">
        <i id="connectButton" class="fa-solid fa-wallet fa-xl"></i>
        <img id="walletCog" class="nav-vector-cog" src="images/nav_cog.svg" />
      </div>

      <div class="options-menu" id="optionsMenu">
        <a
          href="https://app.gmx.io/#/accounts/0x2cfC8747593f77f3dDf92E55b296d3B6307361D7?network=arbitrum&v=2"
          target="_blank"
          class="navButton tardfolioLink"
        >
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-solid fa-dollar-sign fa-xl"></i>
        </a>

        <a
          target="_blank"
          href="https://github.com/howlonghasitBen"
          class="navButton gitLink"
        >
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-regular fa-file-code fa-xl"></i>
        </a>
        <a href="./index.html" class="navButton homeLink">
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-solid fa-house fa-xl"></i>
        </a>

        <a
          target="_blank"
          href="https://substack.com/@howlonghasitben"
          class="navButton writingLink"
        >
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-solid fa-pen-nib fa-xl"></i>
        </a>

        <a class="navButton musicLink">
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-solid fa-music fa-xl"></i>
        </a>

        <a class="navButton nftsLink">
          <img class="mini-cog" src="images/nav_cog.svg" />
          <i class="fa-solid fa-palette fa-xl"></i>
        </a>
      </div>
    </div>

    <div class="bodyContent">
      <div id="leftContent">
        <div id="leftContentInner">
          <i id="openModal" class="fa-solid fa-tv fa-xl"></i>
          <div class="cardFront">
            <img id="frontSvg" src="images/pepe-beach/svg_final.svg" alt="" />
          </div>
        </div>

        <div id="bgCanvasBackside">
          <iframe
            src="https://sanko.tv/howlonghasitBen"
            frameborder="0"
            scrolling="no"
            id="backIframe"
            sandbox
          ></iframe>

          <a
            href="https://sanko.tv/howlonghasitBen"
            target="_blank"
            id="iframeOverlay"
          ></a>

          <h1>X</h1>
        </div>
      </div>

      <div class="rightContentWrapper">
        <div id="rightContent">
          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x495f947276749ce646f68ac8c248420045cb7b5e/87653906629755242846824564470985852918915693352724213351991153572008960196609"
            >
              <img
                src="https://assets.raribleuserdata.com/prod/v1/image/t_image_big/aHR0cHM6Ly9pLnNlYWRuLmlvL2dhZS84RWRseVY5VVBzOXJEOHpib0NfY2laTS0xQ1B6SXBMbDBsdUVkNlJQQkRZMlQwN1JWSG5lUWp6Z3l1TEZJNkJEenhqaTdMMGpIUjBOV1Z2cTJTRUwwdmwzVGthODlOdlJMN3hodUE/dz01MDAmYXV0bz1mb3JtYXQ="
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a id="polygon_WAVEMintButton" href="#">
              <img src="images/pepe-beach/gifs/polygon_WAVE.gif" alt="" />
              <div class="bidButton">
                <p>Mint Now!</p>
              </div>
            </a>
          </div>

          <div id="mumu-frensMintButton" class="caroselItem">
            <img src="images/proof-mumu.png" alt="" />
            <div class="bidButton">
              <p>Mint Now! [0.005 ETH]</p>
            </div>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x495f947276749ce646f68ac8c248420045cb7b5e/87653906629755242846824564470985852918915693352724213351991153568710425313281"
            >
              <img
                src="https://i.seadn.io/gae/2d1Fe9F-MHsh0dJ4zchP3roOoW7tsD9iFNC2-EKrKUwEtvg31qjuTWmIB2EMmE66aWml8qjtZGS6gZtu-KaIaAyPwF8OycOHSX_9?w=500&auto=format"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x495f947276749ce646f68ac8c248420045cb7b5e/87653906629755242846824564470985852918915693352724213351991153577506518335489"
            >
              <img
                src="https://i2.seadn.io/ethereum/0x495f947276749ce646f68ac8c248420045cb7b5e/3a6fdc42689d942d02aa8b1564e62752.png?w=1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x495f947276749ce646f68ac8c248420045cb7b5e/54082"
            >
              <img
                src="https://lh3.googleusercontent.com/SIS0KoeLFwVZ0tIxPgD1WomFnyCLbG8P-ItvPGUFhcwK3SGmPqgvXUXu8sRH8T1ysZ9uRBlaC4Q61XICQU_L_swpIwSZawEwvaw=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/710097"
            >
              <img
                src="https://lh3.googleusercontent.com/F1aBQUOTkp2twzqatlCnwaKS3BQXh7zINRuOMFalmETJ1IyehNhxxE0RIn3z3FYjNUn6_B9GDk4bZrU41KavrkzQSqOpdfCzPd1S=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/68609"
            >
              <img
                src="https://assets.raribleuserdata.com/prod/v1/image/t_gif_big/aHR0cHM6Ly9pcGZzLnJhcmlibGV1c2VyZGF0YS5jb20vaXBmcy9RbU54TDZHdDZTaWpKcTZtYTdtUmRDVFQza0toSG04cDVGN2FOd1ZkQzJ2Q0JEL2ltYWdlLmdpZg=="
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/61018"
            >
              <img
                src="https://lh3.googleusercontent.com/ZMr-eSCfPrDAnQBVHm-EALgJOWD-4kTSZNM8T2_8M1Stq1GEGn4grJfjXSa2KCGqc7JlKpLc6bMQv7oH_Art94g9MUhSIUvbBK4=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/103115"
            >
              <img
                src="https://lh3.googleusercontent.com/zitas8arc_xE7n1BbgXH3Z3IaPDuGOuWwKaD5qvAfQMx1bFpMJ58ZioZoiJmP80xGorlBGBizMdWYIWl4Qw0NF0oXqZt1pWoSQ=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/732409"
            >
              <img
                src="https://lh3.googleusercontent.com/sLz71egZDW4_WmswRtMEOIVWTWkGlloQDxbOcBMD41RRzGKKbVg-diVQ8Wioz79xdxKcNR3lIXoiIBF5jVTgd_SxBS1CJJCpsg=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>

          <div class="caroselItem">
            <a
              target="_blank"
              href="https://opensea.io/item/ethereum/0x60f80121c31a0d46b5279700f9df786054aa5ee5/96165"
            >
              <img
                src="https://lh3.googleusercontent.com/uHJWm4Nc5ozKhSmZGT8sXczCsXwzQIJ4UPZMjZsyoJ0piIY633Xeqw-lwfNGeaUtH3cf8eV0h6PXOD973MjkSp3Jr3bufLzlBR0=s1000"
                alt=""
              />
              <div class="bidButton">
                <p>Bid on Opensea!</p>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="surfHeader">
        <h1>üåä Whirlpool Staking</h1>
        <div id="contractStatus" class="status-badge status-inactive">
          Contract Inactive
        </div>
        <div class="wallet-info">
          <div><strong>Connected Wallet:</strong></div>
          <div id="userAddress" class="wallet-address">Not Connected</div>
        </div>
      </div>

      <div class="grid">
        <!-- User Portfolio Card -->
        <div class="card">
          <h2>üíº Your Portfolio</h2>
          <div class="info-item">
            <span class="info-label">SURF Balance:</span>
            <span id="surfBalance" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">LP Tokens Staked:</span>
            <span id="stakedLP" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Pending SURF Rewards:</span>
            <span id="pendingSURF" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Total Claimed:</span>
            <span id="claimed" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Reward Debt:</span>
            <span id="rewardDebt" class="info-value loading">Loading...</span>
          </div>
        </div>

        <!-- Pool Statistics Card -->
        <div class="card">
          <h2>üìä Pool Statistics</h2>
          <div class="info-item">
            <span class="info-label">Total LP Staked:</span>
            <div class="info-value-with-usd">
              <span id="totalStaked" class="info-value loading"
                >Loading...</span
              >
              <span id="totalStakedUSD" class="usd-value">Loading USD...</span>
            </div>
          </div>
          <div class="info-item">
            <span class="info-label">Total Pending SURF:</span>
            <span id="totalPending" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Acc SURF Per Share:</span>
            <span id="accPerShare" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Next Payout In:</span>
            <span id="nextPayout" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Last Payout:</span>
            <span id="lastPayout" class="info-value loading">Loading...</span>
          </div>
        </div>

        <!-- Rewards Info Card -->
        <div class="card">
          <h2>üéÅ Rewards Info</h2>
          <div class="info-item">
            <span class="info-label">Payout Number:</span>
            <span id="payoutNum" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Initial SURF Reward:</span>
            <span id="initReward" class="info-value loading">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Initial Daily Reward:</span>
            <span id="initRewardDay" class="info-value loading"
              >Loading...</span
            >
          </div>
          <div class="info-item">
            <span class="info-label">Unstaking Fee:</span>
            <span id="unstakingFee" class="info-value loading">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="card actions-card">
        <h2>‚ö° Actions</h2>
        <div class="actions-grid">
          <div class="action-group">
            <h3>üîí Stake LP Tokens</h3>
            <div class="input-group">
              <label for="stakeAmount">Amount to Stake:</label>
              <input
                type="number"
                id="stakeAmount"
                placeholder="0.0"
                step="0.000001"
                min="0"
              />
            </div>
            <button id="stakeBtn" class="btn btn-primary">Stake Tokens</button>
          </div>

          <div class="action-group">
            <h3>üîì Withdraw LP Tokens</h3>
            <div class="input-group">
              <label for="withdrawAmount">Amount to Withdraw:</label>
              <input
                type="number"
                id="withdrawAmount"
                placeholder="0.0"
                step="0.000001"
                min="0"
              />
            </div>
            <button id="withdrawBtn" class="btn btn-secondary">
              Withdraw Tokens
            </button>
          </div>

          <div class="action-group">
            <h3>üí∞ Claim Rewards</h3>
            <p style="margin-bottom: 15px; color: #4a5568; line-height: 1.5">
              Claim your pending SURF rewards from staking.
            </p>
            <button id="claimBtn" class="btn btn-success">
              Claim All Rewards
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="surf-widget"
      class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6"
    >
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
          <span class="text-green-500">üí≤</span>
          SURF Price
        </h2>
        <button
          id="refresh-btn"
          class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 transition-colors"
        >
          <span id="refresh-icon">üîÑ</span>
          Refresh
        </button>
      </div>

      <div
        id="error-message"
        class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg items-center gap-2 text-red-700 hidden"
      >
        <span>‚ö†Ô∏è</span>
        <span id="error-text"></span>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <span class="text-gray-600">SURF/USD Price</span>
            <span id="surf-price" class="text-2xl font-bold text-green-600"
              >--</span
            >
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="text-sm text-gray-600 mb-1">SURF/ETH Ratio</div>
            <div id="surf-eth-ratio" class="font-semibold text-blue-700">
              --
            </div>
          </div>

          <div class="bg-purple-50 rounded-lg p-4">
            <div class="text-sm text-gray-600 mb-1">ETH Price</div>
            <div id="eth-price" class="font-semibold text-purple-700">--</div>
          </div>
        </div>

        <div class="bg-yellow-50 rounded-lg p-4">
          <div class="text-sm text-gray-600 mb-1">LP Token Price</div>
          <div id="lp-price" class="font-semibold text-yellow-700">--</div>
        </div>

        <div
          id="last-updated"
          class="text-xs text-gray-500 text-center hidden"
        ></div>

        <div class="text-xs text-gray-400 space-y-1">
          <div>Contract: 0x999b1e6EDC...1F40b</div>
          <div>SURF Token: 0xEa319e87Cf...976c</div>
        </div>
      </div>
    </div>

    <script>
      class SurfPriceWidget {
        constructor() {
          // Contract addresses from your script
          this.whirlpoolAddress = "0x999b1e6EDCb412b59ECF0C5e14c20948Ce81F40b";
          this.surfTokenAddress = "0xEa319e87Cf06203DAe107Dd8E5672175e3Ee976c";

          // Use a public RPC provider
          this.provider = new ethers.providers.JsonRpcProvider(
            "https://eth-mainnet.alchemyapi.io/v2/demo"
          );

          // Cache for LP token price (5 minutes)
          this.lpTokenPriceCache = { price: 0, timestamp: 0 };

          this.loading = false;

          // Contract ABIs (minimal versions needed for price calculation)
          this.whirlpoolAbi = [
            "function surfPool() external view returns (address)",
          ];

          this.pairAbi = [
            "function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
            "function totalSupply() external view returns (uint256)",
            "function token0() external view returns (address)",
            "function token1() external view returns (address)",
          ];

          this.initializeElements();
          this.bindEvents();
          this.fetchTokenPrice();
        }

        initializeElements() {
          this.elements = {
            refreshBtn: document.getElementById("refresh-btn"),
            refreshIcon: document.getElementById("refresh-icon"),
            errorMessage: document.getElementById("error-message"),
            errorText: document.getElementById("error-text"),
            surfPrice: document.getElementById("surf-price"),
            surfEthRatio: document.getElementById("surf-eth-ratio"),
            ethPrice: document.getElementById("eth-price"),
            lpPrice: document.getElementById("lp-price"),
            lastUpdated: document.getElementById("last-updated"),
          };
        }

        bindEvents() {
          this.elements.refreshBtn.addEventListener("click", async () => {
            await this.fetchTokenPrice();
          });
        }

        setLoading(loading) {
          this.loading = loading;
          this.elements.refreshBtn.disabled = loading;

          if (loading) {
            this.elements.refreshIcon.style.animation =
              "spin 1s linear infinite";
          } else {
            this.elements.refreshIcon.style.animation = "none";
          }
        }

        showError(message) {
          this.elements.errorText.textContent = message;
          this.elements.errorMessage.classList.remove("hidden");
          this.elements.errorMessage.style.display = "flex";
        }

        hideError() {
          this.elements.errorMessage.classList.add("hidden");
        }

        // Get live ETH/USD price from CoinGecko API (same as your script)
        async getETHPrice() {
          try {
            const response = await fetch(
              "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd"
            );
            const data = await response.json();
            return data.ethereum.usd;
          } catch (error) {
            console.error("Error fetching ETH price:", error);
            return 2000; // Fallback ETH price
          }
        }

        // Enhanced LP price calculation with CORS handling
        async getLPTokenPrice() {
          try {
            // Cache price for 5 minutes
            if (
              this.lpTokenPriceCache.price > 0 &&
              Date.now() - this.lpTokenPriceCache.timestamp < 300000
            ) {
              return this.lpTokenPriceCache.price;
            }

            console.log("Fetching LP token price with live data...");

            // Get current ETH/USD price
            const ethPriceUSD = await this.getETHPrice();
            console.log("Current ETH price:", ethPriceUSD);

            let whirlpool, pairContract;

            // Handle different provider types
            if (this.provider) {
              // Normal ethers.js provider
              whirlpool = new ethers.Contract(
                this.whirlpoolAddress,
                this.whirlpoolAbi,
                this.provider
              );
            } else if (this.corsProxy) {
              // Use direct RPC calls through CORS proxy
              return await this.getLPTokenPriceDirectRPC(ethPriceUSD);
            } else {
              throw new Error("No provider available");
            }

            const lpTokenAddress = await whirlpool.surfPool();

            pairContract = new ethers.Contract(
              lpTokenAddress,
              this.pairAbi,
              this.provider
            );

            const [reserves, totalSupply, token0, token1] = await Promise.all([
              pairContract.getReserves(),
              pairContract.totalSupply(),
              pairContract.token0(),
              pairContract.token1(),
            ]);

            return this.calculatePricesFromReserves(
              reserves,
              totalSupply,
              token0,
              token1,
              ethPriceUSD
            );
          } catch (error) {
            console.error("Error calculating LP price with live data:", error);
            throw error;
          }
        }

        // Direct RPC calls for CORS proxy
        async getLPTokenPriceDirectRPC(ethPriceUSD) {
          try {
            // For now, return a simplified calculation using CoinGecko
            // This avoids complex RPC calls through CORS proxy
            const response = await fetch(
              "https://api.coingecko.com/api/v3/simple/price?ids=surf-finance&vs_currencies=usd"
            );

            if (response.ok) {
              const data = await response.json();
              const surfPriceUSD = data["surf-finance"]?.usd || 0;
              const surfEthRatio = surfPriceUSD / ethPriceUSD;

              console.log("Using CoinGecko fallback:", {
                surfPriceUSD,
                ethPriceUSD,
                surfEthRatio,
              });

              return {
                lpPrice: 1.0, // Fallback LP price
                surfPriceUSD,
                ethPriceUSD,
                surfEthRatio,
              };
            }
          } catch (error) {
            console.warn("CoinGecko fallback failed:", error);
          }

          // Ultimate fallback
          return {
            lpPrice: 1.0,
            surfPriceUSD: 0,
            ethPriceUSD,
            surfEthRatio: 0,
          };
        }

        // Extract price calculation logic
        calculatePricesFromReserves(
          reserves,
          totalSupply,
          token0,
          token1,
          ethPriceUSD
        ) {
          // Convert reserves (assume 18 decimals for both tokens)
          const reserve0 = parseFloat(
            ethers.utils.formatUnits(reserves.reserve0, 18)
          );
          const reserve1 = parseFloat(
            ethers.utils.formatUnits(reserves.reserve1, 18)
          );
          const totalLPSupply = parseFloat(
            ethers.utils.formatUnits(totalSupply, 18)
          );

          console.log("LP Pair info:", {
            token0,
            token1,
            reserve0,
            reserve1,
            totalLPSupply,
            surfToken: this.surfTokenAddress.toLowerCase(),
          });

          let surfReserve, ethReserve, surfPriceUSD;

          if (token0.toLowerCase() === this.surfTokenAddress.toLowerCase()) {
            surfReserve = reserve0;
            ethReserve = reserve1;
          } else if (
            token1.toLowerCase() === this.surfTokenAddress.toLowerCase()
          ) {
            surfReserve = reserve1;
            ethReserve = reserve0;
          } else {
            console.warn(
              "Neither token appears to be SURF - using fallback calculation"
            );
            const totalValueUSD = (reserve0 + reserve1) * ethPriceUSD * 0.5;
            const lpPrice =
              totalLPSupply > 0 ? totalValueUSD / totalLPSupply : 0;

            this.lpTokenPriceCache = { price: lpPrice, timestamp: Date.now() };
            return { lpPrice, surfPriceUSD: 0, ethPriceUSD };
          }

          // Calculate SURF price in USD
          surfPriceUSD =
            surfReserve > 0 ? (ethReserve / surfReserve) * ethPriceUSD : 0;

          // Calculate total pool value in USD
          const surfValueUSD = surfReserve * surfPriceUSD;
          const ethValueUSD = ethReserve * ethPriceUSD;
          const totalValueUSD = surfValueUSD + ethValueUSD;

          // Calculate LP token price
          const lpPrice = totalLPSupply > 0 ? totalValueUSD / totalLPSupply : 0;

          console.log("Live price calculation:", {
            ethPriceUSD: ethPriceUSD.toFixed(2),
            surfPriceUSD: surfPriceUSD.toFixed(6),
            surfReserve: surfReserve.toFixed(2),
            ethReserve: ethReserve.toFixed(6),
            surfValueUSD: surfValueUSD.toFixed(2),
            ethValueUSD: ethValueUSD.toFixed(2),
            totalValueUSD: totalValueUSD.toFixed(2),
            totalLPSupply: totalLPSupply.toFixed(6),
            lpPrice: lpPrice.toFixed(6),
          });

          // Cache the result
          this.lpTokenPriceCache = {
            price: lpPrice,
            timestamp: Date.now(),
          };

          return {
            lpPrice,
            surfPriceUSD,
            ethPriceUSD,
            surfEthRatio: surfReserve > 0 ? ethReserve / surfReserve : 0,
          };
        }

        async fetchTokenPrice() {
          this.setLoading(true);
          this.hideError();

          try {
            const priceData = await this.getLPTokenPrice();

            this.updateUI(priceData);
            this.updateLastUpdated();
          } catch (error) {
            this.showError(error.message);
          } finally {
            this.setLoading(false);
          }
        }

        updateUI(data) {
          if (data.surfPriceUSD) {
            this.elements.surfPrice.textContent = `$${data.surfPriceUSD.toFixed(
              6
            )}`;
            this.elements.surfEthRatio.textContent =
              data.surfEthRatio.toFixed(8);
          } else {
            this.elements.surfPrice.textContent = "--";
            this.elements.surfEthRatio.textContent = "--";
          }

          this.elements.ethPrice.textContent = data.ethPriceUSD
            ? `$${data.ethPriceUSD.toFixed(2)}`
            : "--";
          this.elements.lpPrice.textContent = data.lpPrice
            ? `$${data.lpPrice.toFixed(6)}`
            : "--";
        }

        updateLastUpdated() {
          const now = new Date();
          this.elements.lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
          this.elements.lastUpdated.classList.remove("hidden");
        }
      }

      // Initialize the widget when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, initializing widget...");

        // Wait a bit for ethers to load, then initialize
        setTimeout(() => {
          try {
            const widget = new SurfPriceWidget();
            window.surfWidget = widget;
            console.log("Widget initialized successfully");
          } catch (error) {
            console.error("Failed to initialize widget:", error);
            document.getElementById("surf-price").textContent = "Error loading";
          }
        }, 1000);
      });

      // Auto-refresh every 5 minutes
      setInterval(() => {
        if (window.surfWidget && !window.surfWidget.loading) {
          console.log("Auto-refreshing prices...");
          window.surfWidget.fetchTokenPrice();
        }
      }, 5 * 60 * 1000);
    </script>
  </body>
</html>
